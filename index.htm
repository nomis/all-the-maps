<!DOCTYPE html>
<!--
	all-the-maps - Links to all the map services for a latitude/longitude location
	Copyright 2023  Simon Arlott

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Affero General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Affero General Public License for more details.

	You should have received a copy of the GNU Affero General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
	<head>
		<title id="title">All The Maps</title>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3E%F0%9F%97%BA%EF%B8%8F%3C%2Ftext%3E%3C%2Fsvg%3E" />
		<style type="text/css">
		.page, .page:target ~ .default-page { display: none; }
		.default-page, .page:target { display: block; }
		#location h1, #location p { display: inline; font-size: medium; }
		nav ul { list-style-type: none; margin: 0; padding: 0; }
		nav ul li { display: inline; }
		nav a { display: inline-block; padding: 1ex; margin: 1ex; border: 1px solid; border-radius: 1ex; text-align: center; }
		input { font-size: large; }
		.statements p { display: block !important; font-size: small !important; }
		</style>
	</head>
	<body>
		<noscript>I don't like JavaScript either but it's the only way to get your location and avoid transmitting locations to the webserver.</noscript>

		<div id="find" class="page">
			<h1>Find me</h1>
			<p>
				<span id="status">Loading</span><br>
				<span id="details" style="visibility: hidden">
				<br>
				Latitude: <span id="geo_lat">?</span><br>
				Longitude: <span id="geo_lon">?</span><br>
				Accuracy: <span id="geo_acc">?</span>m<br>
				</span>
				<span id="updated" style="visibility: hidden">
				<br>
				Last updated: <span id="when">?</span>s ago
				</span>
			</p>
			<nav>
				<ul>
					<li><a href="#">Enter location</a></li>
					<li><a id="use" href="javascript:use_location()" style="visibility: hidden">Use location</a></li>
					<li><a id="retry" href="javascript:geo_restart(true)" style="visibility: hidden">Retry</a></li>
				</ul>
			</nav>
		</div>

		<div id="location" class="page">
			<h1>Location</h1>
			<p><span id="lat_long">?, ?</span></p>
			<nav>
				<ul>
					<li><a id="osm"><img height="96px" src="/Openstreetmap_logo.svg" alt="OpenStreetMap"></a></li>
					<li><a id="android"><img height="96px" src="/Android_robot.svg" alt="Android App"></a></li>
					<li><a id="google"><img width="96px" src="/Google_Maps_logo_2020.svg" alt="Google Maps"></a></li>
					<li><a id="apple"><img height="48px" src="/Apple_Maps_logo.svg" alt="Apple Maps"></a></li>
					<li><a id="geohack"><img height="96px" src="/Wikimedia_Cloud_Services_logo_with_text.svg" alt="Wikimedia Cloud Services"><br>GeoHack</a></li>
					<hr>
					<li><a href="javascript:reset_location()">Change location</a></li>
					<li><a href="javascript:copy_location()"">Copy to clipboard</a></li>
				</ul>
			</nav>
			<hr>
			<div class="statements">
			<p>The OpenStreetMap magnifying glass logo is a trademark of the <a href="https://www.osmfoundation.org/">OpenStreetMap Foundation</a>,
				and is used with their permission. This website is not endorsed by or affiliated with the OpenStreetMap Foundation.</p>
			<p>The Android robot is a registered trademark of <a href="https://about.google/">Google LLC</a>. This website is not endorsed by or affiliated with Google LLC.</p>
			<p>The Apple logo is a trademark of Apple Inc., registered in the U.S. and other countries and regions. This website is not endorsed by or affiliated with Apple Inc.</p>
			<p>The Wikimedia Cloud Services logo is a trademark of the <a href="https://wikimediafoundation.org/">Wikimedia Foundation</a> and is used with the permission of the
				Wikimedia Foundation. This website is not endorsed by or affiliated with the Wikimedia Foundation.</p>
			<p>The <q><a href="https://foundation.wikimedia.org/wiki/File:Wikimedia_Cloud_Services_logo_with_text.svg">Wikimedia Cloud Services logo</a></q>
				image is licensed under the <a href="https://en.wikipedia.org/wiki/en:Creative_Commons">Creative Commons</a>
				<a href="https://creativecommons.org/licenses/by-sa/3.0/deed.en">Attribution-Share Alike 3.0 Unported</a> licence. It was authored by
				<a href="https://commons.wikimedia.org/wiki/User:Jorm_(WMF)" title="User:Jorm (WMF)">Brandon Harris</a> and
				<a href="https://commons.wikimedia.org/wiki/User:Isarra" title="User:Isarra">some idiot who keeps forgetting her username</a>
				on 2012-06-12.</p>
			</div>
		</div>

		<div id="start" class="page default-page">
			<h1>All The Maps</h1>
			<nav><h2><a href="/#find">Find me</a></h2></nav>
			<form action="javascript:goto_location()" onreset="javascript:focus_location()">
			<h2>Enter <label for="location">Location</label></h2>
				<input id="input" type="text" name="location" size="20"
					placeholder="latitude,longitude" autocomplete="on" autofocus required
					pattern="[^0-9-]*(-?[1-9]*[0-9]+(?:\.[0-9]+)?)[^0-9-]+(-?[1-9]*[0-9]+(?:\.[0-9]+)?)[^0-9]*">
				<input type="submit" value="Go">
				<br><br><br>
				<input type="reset" value="Clear">
			</form>
		</div>

		<script type="text/javascript">
		const any_lat_long = /[^0-9-]*(-?[1-9]*[0-9]+(?:\.[0-9]+)?)[^0-9-]+(-?[1-9]*[0-9]+(?:\.[0-9]+)?)[^0-9]*/;
		const strict_lat_long = /^#(-?[1-9]*[0-9]+(?:\.[0-9]+)?,-?[1-9]*[0-9]+(?:\.[0-9]+)?)$/;

		var geo_handler = undefined;
		var geo_options = {
			enableHighAccuracy: true,
			timeout: 30000,
			maximumAge: 0,
		};
		var geo_retry = undefined;
		var geo_time = undefined;
		var geo_timer = undefined;

		function goto_location() {
			var match = document.getElementById("input").value.match(any_lat_long);
			if (match) {
				window.location.hash = `${match[1]},${match[2]}`;
			}
		}

		function update_location() {
			if (window.location.search != "") {
				window.location.search = "";
			}

			if (window.location.hash != "#find") {
				geo_stop(true);
			}

			var match = location.hash.match(/^#(-?[1-9]*[0-9]+(?:\.[0-9]+)?),(-?[1-9]*[0-9]+(?:\.[0-9]+)?)(?:@([2-9]|1[0-9]|2[01]))?$/);
			if (match) {
				var lat = match[1];
				var lon = match[2];
				var zoom = match[3];

				if (zoom == undefined) {
					zoom = "19";
				}

				document.getElementById("lat_long").innerText = `${lat}, ${lon}`;
				document.getElementById("input").value = `${lat},${lon}`;
				document.getElementById("start").style = "display: none;";
				document.getElementById("location").style = "display: block";
				document.getElementById("title").innerText = `All The Maps (${lat}, ${lon})`;

				document.getElementById("osm").href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=${zoom}&layers=M`;
				document.getElementById("android").href = `geo:0,0?z=${zoom}&q=${lat},${lon}`;
				document.getElementById("google").href = `https://www.google.com/maps?ll=${lat},${lon}&q=${lat},${lon}&t=m&z=${zoom}`;
				document.getElementById("apple").href = `https://maps.apple.com/?ll=${lat},${lon}&q=${lat},${lon}&t=m&z=${zoom}`;
				document.getElementById("geohack").href = `https://geohack.toolforge.org/geohack.php?language=en&params=${lat};${lon}_dim:1`;
			} else {
				document.getElementById("location").style = "";
				document.getElementById("start").style = "";
				document.getElementById("title").innerText = "All The Maps";

				if (window.location.hash == "" || window.location.hash == "#") {
					focus_location();
				} else if (window.location.hash == "#find") {
					if (geo_handler == undefined) {
						geo_restart(true);
					}
				}
			}
		}

		function reset_location() {
			window.location.hash = "";

			if (window.location.search != "") {
				window.location.search = "";
			}
		}

		function copy_location() {
			navigator.clipboard.writeText(window.location.href);
		}

		function focus_location() {
			document.getElementById("input").focus();
		}

		function geo_restart(clear) {
			geo_stop(true);

			if (window.location.hash != "#find") {
				return;
			}

			document.getElementById("details").style = "visibility: hidden";
			document.getElementById("geo_lat").innerText = "?";
			document.getElementById("geo_lon").innerText = "?";
			document.getElementById("geo_acc").innerText = "?";

			if (clear) {
				document.getElementById("updated").style = "visibility: hidden";
				document.getElementById("when").innerText = "?";
			}

			document.getElementById("retry").style = "visibility: hidden";
			document.getElementById("use").style = "visibility: hidden";

			if (navigator.geolocation) {
				document.getElementById("status").innerText = "Waiting for location";
				geo_updated(false);

				geo_handler = navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);
			} else {
				geo_unavailable();
			}
		}

		function geo_updated(available) {
			if (geo_timer != undefined) {
				clearInterval(geo_timer);
			}

			if (available) {
				document.getElementById("details").style = "";
				document.getElementById("retry").style = "visibility: hidden";
				document.getElementById("use").style = "";
			} else {
				document.getElementById("details").style = "visibility: hidden";
				document.getElementById("retry").style = "";
				document.getElementById("use").style = "visibility: hidden";
			}

			geo_time = Date.now();
			geo_relative_time();
			geo_timer = setInterval(geo_relative_time, 500);
		}

		function geo_relative_time() {
			document.getElementById("updated").style = "";
			document.getElementById("when").innerText = `${Math.round((Date.now() - geo_time) / 1000)}`;
		}

		function geo_success(pos) {
			document.getElementById("status").innerText = "Location found";

			document.getElementById("geo_lat").innerText = `${pos.coords.latitude}`;
			document.getElementById("geo_lon").innerText = `${pos.coords.longitude}`;
			document.getElementById("geo_acc").innerText = `${pos.coords.accuracy.toFixed(2)}`;

			geo_updated(true);
		}

		function geo_error(err) {
			var message = "Unknown error";
			var failed = false;

			if (err.code == err.PERMISSION_DENIED) {
				message = "Permission denied (you need to allow this website to access your location)";
				failed = true;
			} else if (err.code == err.POSITION_UNAVAILABLE) {
				message = "Position unavailable";
			} else if (err.code == err.TIMEOUT) {
				message = "Timeout occurred";
			} else {
				failed = true;
			}

			document.getElementById("status").innerText = message;
			geo_updated(false);

			if (failed) {
				geo_stop(false);
			} else {
				geo_stop(false);
				geo_retry = setTimeout(geo_auto_restart, 3000);
			}
		}

		function geo_unavailable() {
			document.getElementById("status").innerText = "Location not supported";
			geo_updated(false);
		}

		function geo_stop(all) {
			if (geo_handler != undefined) {
				navigator.geolocation.clearWatch(geo_handler);
				geo_handler = undefined;
			}

			if (geo_retry != undefined) {
				clearTimeout(geo_retry);
				geo_retry = undefined;
			}

			if (all) {
				if (geo_timer != undefined) {
					clearInterval(geo_timer);
					geo_timer = undefined;
				}
			}
		}

		function geo_auto_restart() {
			geo_restart(false);
		}

		function use_location() {
			var lat = document.getElementById("geo_lat").innerText;
			var lon = document.getElementById("geo_lon").innerText;

			document.getElementById("input").value = `${lat},${lon}`;
			goto_location();
		}

		window.onload = update_location;
		window.onhashchange = update_location;
		</script>
	</body>
</html>
